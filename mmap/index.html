<!doctype html>

<html>

<head>

        <title>Lab6</title>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">

        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;libraries=places"></script>
        <link rel = "stylesheet" href="marauder.css"/>

<script>
        var myLat = 0;
        var myLng = 0;
        

        http = new XMLHttpRequest();
        var me = new google.maps.LatLng(myLat, myLng);
        var myOptions = {
                zoom: 13,
                center: me,
                mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map;
        var marker;
        infowindow = new google.maps.InfoWindow();
        var places;



       
        function init(){
                map = new google.maps.Map(document.getElementById("map_canvas"),myOptions);
                getRequest();
                
               
        }

        function getRequest(){
               
               http.open("POST","http://chickenofthesea.herokuapp.com/sendLocation", true);
               http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
               http.send("login=NevilleLongbottom&lat="+ myLat +"&lng="+myLng);
	       http.onreadystatechange = dataReady;
                  
        }

        function renderMap(obj)
        {
               
                me = new google.maps.LatLng(myLat, myLng);
                map.panTo(me);

                var myImg = "beachflag.png";
                
                var marker = new google.maps.Marker({
                        map: map,
                        position: me,
                        title: "NevilleLongbottom",
                        icon: myImg
                });
     
             
 
                marker.setMap(map);
             
               
                      
       

              
        }

        function dataReady(){
	       if(http.readyState == 4){
		
                        obj = JSON.parse(http.responseText);
                        console.log(obj);
                        student_names = accessNames(obj);
                        student_lat = accessLat(obj);
                        student_lng = accessLng(obj);
                        student_created = accessCreated(obj);
                        for( var i = 0; i < obj['students'].length; i++){
                                 student = new google.maps.LatLng(student_lat[i], student_lng[i]);
                                
                                 var marker1 = new google.maps.Marker({
                                           map: map,
                                           animation: google.maps.Animation.BOUNCE,
                                           position: student,
                                           title:student_names[i]+" "+ student_created[i],
                                 });
                                  
                                 google.maps.event.addListener(marker1, 'click', function() {
                                           infowindow.setContent(marker1.title + " Location = " + student);
                                           infowindow.open(map, marker1);
                                 });
                        }

                        char_name = accessCharName(obj);
                        char_lat = accessCharLat(obj);
                        char_lng = accessCharLng(obj);
                        char_note = accessCharNote(obj);
                        
                        for( var j = 0; j < obj['characters'].length; j++){
                                 character = new google.maps.LatLng(char_lat[j], char_lng[j]);
                                 var charMark = [];
                                 
                                 var marker2 = new google.maps.Marker({
                                           map: map,
                                           icon: char_name[j] + ".png",
                                           position: character,
                                           title: char_name[j] + " " + char_note[j]
                                 });
                                
                                 google.maps.event.addListener(charMark[i], 'click', function(){
                                           infowindow.setContent(marker2.title +" Location = " + character);
                                           
                                           infowindow.open(map, charMark[j]);
                                 });
                         }

               }                                                                                    
	           
               if (navigator.geolocation) {
                       navigator.geolocation.getCurrentPosition(function(position) {
                             myLat = position.coords.latitude;
                             myLng = position.coords.longitude;
                             renderMap(obj);
                       });
               }
                   
        }         
         
 

        function accessLng(obj)
        {
            var lng_array = [];

            for (var i = 0; i < obj['students'].length; i++){ 
                lng_array[i] = obj['students'][i]['lng'];
                
            }
            return lng_array;          
        
        }

        function accessLat(obj)
        {
            var lat_array = [];

            for (var i = 0; i < obj['students'].length; i++){ 
                lat_array[i] = obj['students'][i]['lat'];
                
            }
            return lat_array;          
        
        }




        
        function accessCreated(obj)
        {
            var created_array = [];

            for (var i = 0; i < obj['students'].length; i++){ 
                created_array[i] = obj['students'][i]['created_at'];
                
            }
            return created_array;          
        
        }
         
        function accessNames(obj)
        {
        
            var student_array = [];
           
            for (var i = 0; i < obj['students'].length; i++){ 
                student_array[i] = obj['students'][i]['login'];
            }         
            return student_array;
        
        }
      
       function accessCharLat(obj)
       {
            var lat = [];
            for( var i = 0; i < obj['characters'].length; i++){
                lat[i] = obj['characters'][i]['loc']['latitude'];
            }
            return lat;
       }

      function accessCharLng(obj)
      {
            var lng = [];

            for( var i = 0; i < obj['characters'].length; i++){       
                lng[i] = obj['characters'][i]['loc']['longitude'];
            }
            return lng;
      }

      function accessCharName(obj)
      {
            var char_array = [];
         
            for( var i = 0; i < obj['characters'].length; i++){
          
                char_array[i] = obj['characters'][i]['name'];
                
            }
            console.log("hi");
            return char_array;
          
      }
    
      function accessCharNote(obj)
      {
           var char_note = [];
           
           for( var i = 0; i < obj['characters'].length; i++){
               char_note[i] = obj['characters'][i]['loc']['note'];
           }

           return char_note; 
                  
      }   
    

        
    


</script>
</head>
<body onload="init()">
<div id="map_canvas"></div>
<div id="textbox"></div>
</body>
